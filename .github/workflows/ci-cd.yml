name: Unit-tests

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  test-lin:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: "3.12"
      
      - name: Try to run tests
        run: |
          if [ -f "tests.py" ]; then
            echo "Running tests.py"
            python tests.py
          elif [ -f "tests.python" ]; then
            echo "Running tests.python"
            python tests.python
          elif [ -f "test.py" ]; then
            echo "Running test.py"
            python test.py
          else
            echo "Looking for test files..."
            find . -name "*test*.py" -type f | head -5
            echo "No test file found!"
            exit 2
          fi
      
      - name: Test summary
        run: |
          echo "## Linux Test Results" >> $GITHUB_STEP_SUMMARY
          if [ steps.tests.outcome == 'success' ]; then
            echo "All tests passed on Linux" >> $GITHUB_STEP_SUMMARY
          else
            echo "Tests failed on Linux" >> $GITHUB_STEP_SUMMARY
          fi

  test-win:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: "3.12"
      
      - name: Try to run tests on Windows
        shell: pwsh
        run: |
          if (Test-Path "tests.py") {
            echo "Running tests.py"
            python tests.py
          } elseif (Test-Path "tests.python") {
            echo "Running tests.python"
            python tests.python
          } elseif (Test-Path "test.py") {
            echo "Running test.py"
            python test.py -v
          } else {
            echo "Looking for test files..."
            Get-ChildItem -Recurse -Filter "*test*.py" | Select-Object -First 5
            echo "No test file found!"
            exit 2
          }
      
      - name: Windows test summary
        run: |
          echo "## Windows Test Results" >> $GITHUB_STEP_SUMMARY
          if (( "${{ steps.tests_win.outcome }}" -eq 'success' ) {
            echo "All tests passed on Windows" >> $GITHUB_STEP_SUMMARY
          } else {
            echo "Tests failed on Windows" >> $GITHUB_STEP_SUMMARY
          }

  summary:
    needs: [test-lin, test-win]
    runs-on: ubuntu-latest
    steps:
      - name: All summary
        run: |
          echo "# Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Linux | ${{ needs.test-lin.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows | ${{ needs.test-win.result }} |" >> $GITHUB_STEP_SUMMARY